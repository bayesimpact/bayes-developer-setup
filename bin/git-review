#!/bin/bash
readonly REVIEWER=$1

readonly BRANCH="$(git rev-parse --abbrev-ref HEAD)"
if [ -z "${BRANCH}" ]; then
  exit 2
fi

if [ "${BRANCH}" == "master" ]; then
  echo "branch required:" 1>&2
  git branch | grep -v \ master$ 1>&2
  exit 1
fi

# Ensures that current dir is clean.
if [ -n "$(git diff HEAD --shortstat 2> /dev/null | tail -n1)" ]; then
  echo "Current git status is dirty. Commit, stash or revert your changes before sending for review." 1>&2
  exit 3
fi

git push -u origin "${BRANCH}"

readonly MESSAGE_FILE=$(mktemp)

git log "master..${BRANCH}" --format=%B > "${MESSAGE_FILE}"

# TODO: Replace by a programmatic way of setting the reviewer.
if [ -n "${REVIEWER}" ]; then
  echo >> "${MESSAGE_FILE}"
  echo "+@${REVIEWER}" >> "${MESSAGE_FILE}"
fi

# Append message generated by .git-review-hook in repo.
# TODO: Test this feature.
readonly GIT_ROOT="$(git rev-parse --show-toplevel)"
readonly GIT_REVIEW_HOOK="${GIT_ROOT}/.git-review-hook"
if [ -x "${GIT_REVIEW_HOOK}" ]; then
  export BRANCH
  export REVIEWER
  "${GIT_REVIEW_HOOK}" >> "${MESSAGE_FILE}"
fi

hub pull-request -F "${MESSAGE_FILE}" | \
  sed -e "s/github.com/reviewable.io\/reviews/;s/pull\///"

rm "${MESSAGE_FILE}"
